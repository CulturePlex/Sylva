{% extends "base.html" %}
{% load i18n graphs static compress %}
{% get_static_prefix as STATIC_PREFIX %}

{% block navigation_buttons %}
{{ block.super }}
{% endblock %}

{% block title %}
{{ graph.name }}
{% endblock %}

{% block menu_buttons %}
{% toolbar on="operator" %}
{% endblock %}

{% block content_title %}
{% trans "Queries" as parent %}
{% trans "Query" as label %}
{% breadcrumb graph parent label %}
{% endblock %}

{% block content %}
{% if node_types %}
<div style="width: 570px;">
    <div class="nav-links">
        <a id="builder-query"><h2 style="display: inline;">{% trans "Query" %}</h2></a>
        <h2 style="display: inline;"> | </h2>
        <a id="builder-results"><h2 style="display: inline;">{% trans "Results" %}</h2></a>
    </div>
    <div id="query-builder-query">
        <div class="content2-second diagram" style="margin-top: 15px;">
            <nav id="select-node">
                <a href="#">{% trans "Types" %}</a>
                <ul id="node-options" class="dropdown">
                {% for node_type in node_types %}
                    <li style="padding: 3px;">
                        <a class="add-box" data-type="{{node_type.slug}}" href="javascript:void(0);">{{ node_type.name|capfirst }}</a>
                    </li>
                {% endfor %}
                <!-- Wildcard type - It needs to be improved -->
                    <li style="padding: 3px;">
                        <a class="add-box" data-type="wildcard" href="javascript:void(0);">{% trans "Wildcard Type" %}</a>
                    </li>
                </ul>
            </nav>
            <div id="diagramContainer" style="width: 1092px; margin-top: 20px;">
                <div id="diagram"></div>
            </div>
        </div>
        <a class="button" id="run-button" href="#">{% trans "Run" %}</a>
        <a class="button" id="clear-button" href="#">{% trans "Clear query" %}</a>
        <form method="post" action="." id="formSaveQuery" name="form query save">
            {% csrf_token %}
            {% if form.errors %}
                {% for field in form %}
                    {% for error in field.errors %}
                        <div class="alert alert-error">
                            <strong>{{ error|escape }}</strong>
                        </div>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-error">
                        <strong>{{ error|escape }}</strong>
                    </div>
                {% endfor %}
            {% endif %}
            <label id="labelName" for="name">Name: </label>
            {{ form.name }}
            <label id="labelDescription" for="description">Description: </label>
            {{ form.description }}
            {{ form.results_count }}
            {{ form.last_run }}
            {{ form.query_dict }}
            {{ form.query_aliases }}
            {{ form.query_fields }}
            <input type="submit" id="saveQuery" name="saveQuery" value="{% trans "Save query" %}" />
        </form>
    </div>
    <div id="query-builder-results">
        <div id="results"></div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_links %}
    {% compress css %}
        <link rel="stylesheet" type="text/css" href="{{ STATIC_PREFIX }}css/schemas.diagram.css" />
        <link rel="stylesheet" type="text/css" href="{{STATIC_PREFIX}}operators/css/operators.css" />
        <link rel="stylesheet" type="text/css" href="{{ STATIC_PREFIX }}css/chosen.css" />
        <link href="{{ STATIC_PREFIX }}css/token.input.css" type="text/css" rel="stylesheet" />
        <link href="{{ STATIC_PREFIX }}css/jqueryui.1.8.18.css" type="text/css" rel="stylesheet" />
    {% endcompress %}
{% endblock %}
{% block extra_scripts %}
<script type="text/javascript">
    if (!diagram) {
        var diagram = {};
    }

    diagram.Models = {% autoescape off %}{{ graph.schema.get_schema_diagram }}{% endautoescape %};

    diagram.url_collaborators = "{% url "graph_query_collaborators" graph.slug %}";
    diagram.url_query = "{% url "operator_builder_results" graph.slug %}";
    diagram.relationshipImageSrc = "{{ STATIC_PREFIX }}img/rarr2.gif";
</script>

{% compress js %}
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/jquery-ui-1.9.1.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/jquery.jsPlumb-1.5.5-min.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/jquery.scrollto.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/chosen.jquery.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/chosen.ajax.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/jqueryui.timepicker.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}js/jquery.blockUI.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}operators/js/operators.query.js"></script>
    <script type="text/javascript" src="{{ STATIC_PREFIX }}operators/js/operator_builder.js"></script>
{% endcompress %}


{# Not using compressor from here becuase it needs a huge refactoring: Django template's if statements are being used! #}

<!-- If we have the run variable, we execute the query -->
{% if run_query %}
<script type="text/javascript">
    var run = true;
</script>
{% endif %}

<!-- The next 'ifs' are for the case that we are going to edit a query.
     In that case, we send from the backend the json files to build the
     the query, and here we get them in JavaScript variables -->

{% if query_dict %}
<script type="text/javascript">
    var query = {};
    var query_dict = '{{ query_dict|safe }}';
    query_dict = JSON.parse(query_dict);
    query["query"] = query_dict;
</script>
{% endif %}

{% if query_aliases %}
<script type="text/javascript">
    var query_aliases = '{{ query_aliases|safe }}';
    query_aliases = JSON.parse(query_aliases);
    query["aliases"] = query_aliases;
</script>
{% endif %}

{% if query_fields %}
<script type="text/javascript">
    var query_fields = '{{ query_fields|safe }}';
    query_fields = JSON.parse(query_fields);
    query["fields"] = query_fields["fields"];
    query["fieldRelsCounter"] = query_fields["fieldRelsCounter"];
    query["checkboxes"] = query_fields["checkboxes"];
    query["fieldsConditions"] = query_fields["fieldsConditions"];

    (function($) {
        $(document).on('ready', function() {
            diagram.loadQuery(JSON.stringify(query));
            if(run) {
                //$('#builder-results').click();
                $('#run-button').click();
            }
        });
    })(jQuery);
</script>
{% endif %}
{% endblock %}
