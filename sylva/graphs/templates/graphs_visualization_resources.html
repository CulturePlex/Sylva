{% load converter_filters %}
<script type="text/javascript">
  sylva.nodeViewURL = "{% url "nodes_view" graph.slug 0 %}";
  sylva.nodeEditURL = "{% url "nodes_edit" graph.slug 0 %}";
  {% if analytics %}
      sylva.is_graph_empty = {{ is_graph_empty|to_javascript }};
      sylva.is_schema_empty = {{ is_graph_empty|to_javascript }};
  {% else %}
    sylva.is_graph_empty = false;
    sylva.is_schema_empty = false;
  {% endif %}
  sylva.view_graph_ajax_url = "{{ view_graph_ajax_url }}";
  sylva.edit_nodetype_color_ajax_url = "{{ edit_nodetype_color_ajax_url }}";
  sylva.edit_reltype_color_ajax_url = "{{ edit_reltype_color_ajax_url }}";
  sylva.graph_analytics_boxes_edit_position = "{{ graph_analytics_boxes_edit_position }}";
</script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/sigma.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.layout.forceAtlas2.min.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.parsers.gexf.min.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.parsers.json.min.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.plugins.animate.min.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.plugins.dragNodes.min.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.plugins.neighborhoods.min.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma/plugins/sigma.renderers.customShapes.min.js"></script>

<script type="text/javascript" src="{{ STATIC_PREFIX }}js/jquery-ui-1.10.4.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/jquery/jquery.simulate.js"></script>

<script src="{{ STATIC_PREFIX }}js/jquery.simplemodal-1.4.4.js"></script>

<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/colpick/colpick.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/colpick/rgbcolor.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/jquery/jquery.xcolor.js"></script>

<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/paper/paper-core.min.js"></script>

<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/visualizations.js"></script>
<script type="text/javascript" src="{{ STATIC_PREFIX }}graphs/js/sigma-visualization.js"></script>

<link type="text/css" rel="stylesheet" href="{{ STATIC_PREFIX }}css/jqueryui.1.8.18.css" />
<link type="text/css" rel="stylesheet" href="{{ STATIC_PREFIX }}graphs/css/colpick/colpick.css" />
<link type="text/css" rel="stylesheet" href="{{ STATIC_PREFIX }}graphs/css/colpick/colpick.mod.css" />

{% if OPTIONS.ENABLE_ANALYTICS %}
<!-- Begin code for the analytics side -->
<script src="//code.highcharts.com/highcharts.js"></script>
<script src="//code.highcharts.com/modules/exporting.js"></script>
<script type="text/javascript">

// Variable to store the ids to plot the results of the analytics
var analyticsId = {};
var taskTime = 0;

jQuery(document).ready(function() {
      /**
      * AJAX Setup for CSRF Django token
      */
    $.ajaxSetup({
         beforeSend: function(xhr, settings) {
             function getCookie(name) {
                 var cookieValue = null;
                 if (document.cookie && document.cookie != '') {
                     var cookies = document.cookie.split(';');
                     for (var i = 0; i < cookies.length; i++) {
                         var cookie = jQuery.trim(cookies[i]);
                         // Does this cookie string begin with the name we want?
                     if (cookie.substring(0, name.length + 1) == (name + '=')) {
                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                         break;
                     }
                 }
             }
             return cookieValue;
             }
             if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                 // Only send the token to relative URLs i.e. locally.
                 xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
             }
         }
    });
    // get results of the analytic
    var getResults = function(results_url, algorithm) {
      $.ajax({
          type: "GET",
          dataType: 'json',
          url: results_url,
          success: function (data) {
            var parentArray = new Array();
            for(var i in data) {
              var childArray = new Array();
              childArray.push(parseFloat(i));
              childArray.push(data[i]);
              parentArray.push(childArray);
            }
            var options = {
                chart: {
                    renderTo: analyticsId[algorithm],
                    type: 'scatter'
                },
                title: {
                    text: algorithm
                },
                xAxis: {
                    title: {
                        text: 'Algorithm value'
                    }
                },
                yAxis: {
                    title: {
                        text: 'Units'
                    }
                },
                plotOptions: {
                    scatter: {
                        marker: {
                            radius: 5,
                            states: {
                                hover: {
                                    enabled: true,
                                    lineColor: 'rgb(100,100,100)'
                                }
                            }
                        },
                        states: {
                            hover: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },
                        tooltip: {
                            headerFormat: '<b>{series.name}</b><br>',
                            pointFormat: '{point.y} with {point.x} ' + algorithm + ''
                        }
                    }
                },
                series: [{
                  name: algorithm,
                  color: 'rgba(223, 83, 83, .5)',
                  data: parentArray
                }]
            };

            // Create the chart
            var chart = new Highcharts.Chart(options);
          },
          error: function () {
              alert("Error");
          }
      });
    }

    // pole state of the current task
    var getTaskState = function(task_id, algorithm, progressBarId) {
      $.ajax({
        type: "GET",
        url: "{% url 'analytics_status' graph.slug %}",
        data: {"id": task_id}
      }).done(function(task){
        if(!task) {
            window.setTimeout(function() {
              getTaskState(task_id, algorithm, progressBarId);
            }, 1000);
            taskTime = taskTime + 7;
            $(progressBarId).attr('value', taskTime);
        } else {
          getResults(task, algorithm);
          $(progressBarId).attr('value', 100);
          taskTime = 0;
        }
        // create the infinite loop of Ajax calls to check the state
        // of the current task
      });
    }

    $('.play-algorithm').on('click', function() {
        var $this = $(this);
        var measure = $this.data('measure');
        var plotId = $this.data('plot');
        var etaId = $this.data('eta');
        var progressBarId = "#progress-bar-" + measure;

        analyticsId[measure] = plotId;

        jQuery.ajax({
            type: "POST",
            url: "{% url 'analytics_estimate' graph.slug %}",
            data: {"algorithm": measure}
        }).done(function(data){
            var algorithm = data[0];
            var eta_time = data[1];
            if(eta_time < 10) {
              $(progressBarId).attr('max', 100);
            } else {
              $(progressBarId).attr('max', 300);
            }
            $('#' + etaId).html("Estimated time " + eta_time);
        });
        jQuery.ajax({
            type: "POST",
            url: "{% url 'analytics_run' graph.slug %}",
            data: {"algorithm": measure}
        }).done(function(data){
            var task_id = data[0];
            var algorithm = data[1];
            getTaskState(task_id, algorithm, progressBarId);
            $(progressBarId).css({
              'visibility': 'visible'
            });
        });
    });

    $('.analytics-measure').accordion({
      collapsible: true,
      create: function(event, ui) {
        var box = $(event.target);
        var children = box.children();
        var header =  children.first();
        var body = $(children[1]);
        var span = header.children().first();

        // The next lines remove jQueryUI style from the boxes.
        box.removeClass('ui-widget ui-accordion');
        header.removeClass('ui-accordion-icons ' +
          'ui-accordion-header ui-helper-reset ui-state-default');
        body.removeClass('ui-accordion-content ui-widget-content');
        body.css('height', '');
        span.remove();
      },
      active: false,
      heightStyle: 'content'
    });

    $(document).on('change', '.last-analytics', function() {
      var $this = $(this);
      var analyticId = $('option:selected', $this).val();

      $.ajax({
        type: "GET",
        url: "{% url 'analytics_analytic' graph.slug %}",
        data: {"id": analyticId}
      }).done(function(result){
        var resultsUrl = result[0];
        var algorithm = result[1];
        console.log(resultsUrl);
        console.log(algorithm);
        getResults(resultsUrl, algorithm);
      });
    });

    $('#analytics-algorithms').sortable();
});
</script>
<!-- End code for the analytics side -->
{% endif %}
