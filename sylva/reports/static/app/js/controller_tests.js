"use strict";

describe("TestCtrls", function () {

    var $httpBackend, $rootScope, createController, listEndpoint,
    templateEndpointNew, previewEndpoint, historyEndpoint, historyInstEndpoint;

    beforeEach(module('reports'));

    beforeEach(inject(function($injector) {
        // Set up the mock http service responses
        $httpBackend = $injector.get('$httpBackend');
        // backend definition common for all tests
        listEndpoint = $httpBackend.when('GET', '/reports/dh/list?page=1').respond(
            {'templates': [{'frequency': 'h', 'layout': {'layout': [[{'ySeries': [], 'rowspan': '1', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}, {'alias': 'Count(project_1.Name)', 'display_alias': 'Count(Project 1.Name)'}], 'colspan': '1', 'col': 0, 'colors': {'Count(institution_1.Name)': '#16DEC0', 'country_1.Name': '#F7FBFA', 'Count(project_1.Name)': '#D73E68'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': '', 'chartType': 'column', 'displayQuery': 3, 'id': 'cell1', 'row': 0}, {'ySeries': [], 'rowspan': '1', 'displayMarkdown': '#Heading 1\n##Heading 2\n###Heading 3\n* A list of items\n - sub item', 'yAxis': [], 'colspan': '1', 'col': 1, 'xAxis': '', 'series': [['Keanu Reeves', 36], ['Linus Torvalds', 24], ['Tyrion Lannister', 20], ['Morpheus', 1], ['F\xe9lix Lope de Vega Carpio', 156], ['Javier de la Rosa', 24]], 'chartType': '', 'displayQuery': '', 'id': 'cell2', 'row': 0}], [{'ySeries': [], 'rowspan': '1', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}], 'colspan': 2, 'col': 0, 'colors': {'Count(institution_1.Name)': '#1C93BA', 'country_1.Name': '#BA21E0'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': '', 'chartType': 'line', 'displayQuery': 2, 'id': 'cell3', 'row': 1}]], 'pagebreaks': {'1': false, '0': false}}, 'name': 'Controller Test', 'collabs': [{'id': 'davebshow', 'display': 'davebshow'}], 'description': '', 'slug': 'controller-test', 'last_run': '"2015-04-16T17:30:00.577416"', 'start_date': '"2015-04-16T15:30:00"'}], 'num_pages': 1, 'total_count': 1, 'num_objects': 1, 'next_page_number': null, 'page_number': 1, 'previous_page_number': null}
        );

        templateEndpointNew = $httpBackend.when('GET', '/reports/dh/templates?queries=true').respond(
            {'template': null, 'queries': [{'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': []}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'datatype': 'string', 'alias': 'Count(institution_1.Name)', 'aggregate': 'Count', 'property': 'Name', 'distinct': false}]}, {'alias': 'located_in_1', 'properties': []}], 'name': 'count_inst', 'id': 1}, {'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'located_in_1', 'properties': []}], 'name': 'new count_inst', 'id': 2}, {'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'project_1', 'properties': [{'display_alias': 'Count(Project 1.Name)', 'alias': 'Count(project_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'produced_by_1', 'properties': []}, {'alias': 'located_in_1', 'properties': []}], 'name': 'two_series', 'id': 3}, {'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'project_1', 'properties': [{'display_alias': 'Count(Project 1.Name)', 'alias': 'Count(project_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'programming_1', 'properties': [{'display_alias': 'Count(Programming 1.Name)', 'alias': 'Count(programming_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'located_in_1', 'properties': []}, {'alias': 'produced_by_1', 'properties': []}, {'alias': 'necessary_for_6_1', 'properties': []}], 'name': 'three', 'id': 4}]}
        );

        previewEndpoint = $httpBackend.when('GET', '/reports/dh/templates').respond(
            {'template': {'frequency': 'h', 'layout': {'layout': [[{'ySeries': [], 'rowspan': '1', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}, {'alias': 'Count(project_1.Name)', 'display_alias': 'Count(Project 1.Name)'}], 'colspan': '1', 'col': 0, 'colors': {'Count(institution_1.Name)': '#16DEC0', 'country_1.Name': '#F7FBFA', 'Count(project_1.Name)': '#D73E68'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': '', 'chartType': 'column', 'displayQuery': 3, 'id': 'cell1', 'row': 0}, {'ySeries': [], 'rowspan': '1', 'displayMarkdown': '#Heading 1\n##Heading 2\n###Heading 3\n* A list of items\n - sub item', 'yAxis': [], 'colspan': '1', 'col': 1, 'xAxis': '', 'series': [['Keanu Reeves', 36], ['Linus Torvalds', 24], ['Tyrion Lannister', 20], ['Morpheus', 1], ['F\xe9lix Lope de Vega Carpio', 156], ['Javier de la Rosa', 24]], 'chartType': '', 'displayQuery': '', 'id': 'cell2', 'row': 0}], [{'ySeries': [], 'rowspan': '1', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}], 'colspan': 2, 'col': 0, 'colors': {'Count(institution_1.Name)': '#1C93BA', 'country_1.Name': '#BA21E0'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': '', 'chartType': 'line', 'displayQuery': 2, 'id': 'cell3', 'row': 1}]], 'pagebreaks': {'1': false, '0': false}}, 'name': 'Controller Test', 'collabs': [{'id': 'davebshow', 'display': 'davebshow'}], 'description': '', 'slug': 'controller-test', 'last_run': 'null', 'start_date': '"2015-04-16T15:30:00"'}, 'queries': [{'series': [['country_1.Name', 'Count(institution_1.Name)'], ['Austria', 3], ['Canada', 7], ['Taiwan', 3], ['Australia', 2], ['Switzerland', 3], ['Hungry', 1], ['Belgium', 2], ['Norway', 2], ['Germany', 28], ['Ireland', 1], ['Italy', 6], ['France', 3], ['Poland', 1], ['Denmark', 1], ['China', 3], ['Russia', 1], ['Sweden', 2], ['Netherlands', 6], ['United States', 35], ['Turkey', 1], ['Latvia', 1], ['Spain', 3], ['New Zealand', 1], ['Serbia', 1], ['Israel', 1], ['United Kingdom', 13], ['Japan', 3], ['Finland', 3]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'located_in_1', 'properties': []}], 'name': 'new count_inst', 'id': 2}, {'series': [['country_1.Name', 'Count(institution_1.Name)', 'Count(project_1.Name)'], ['Austria', 5, 5], ['Canada', 13, 13], ['Taiwan', 4, 4], ['Australia', 1, 1], ['Switzerland', 3, 3], ['Hungry', 1, 1], ['Belgium', 3, 3], ['Norway', 3, 3], ['Germany', 27, 27], ['Ireland', 1, 1], ['Italy', 6, 6], ['France', 3, 3], ['Poland', 1, 1], ['Denmark', 1, 1], ['China', 3, 3], ['Russia', 1, 1], ['Sweden', 2, 2], ['Netherlands', 8, 8], ['United States', 44, 44], ['Turkey', 1, 1], ['Latvia', 1, 1], ['Spain', 4, 4], ['New Zealand', 1, 1], ['Serbia', 1, 1], ['Israel', 1, 1], ['United Kingdom', 25, 25], ['Japan', 3, 3], ['Finland', 3, 3]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'project_1', 'properties': [{'display_alias': 'Count(Project 1.Name)', 'alias': 'Count(project_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'produced_by_1', 'properties': []}, {'alias': 'located_in_1', 'properties': []}], 'name': 'two_series', 'id': 3}]}
        );

        historyEndpoint = $httpBackend.when('GET', '/reports/dh/history?page=1').respond(
            {'num_pages': 1, 'name': 'Controller Test', 'total_count': 2, 'num_objects': 1, 'page_number': 1, 'next_page_number': null, 'reports': [{'bucket': '2015-04-16T00:00:00', 'reports': [{'table': [[{'ySeries': [], 'rowspan': '1', 'name': 'two_series', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}, {'alias': 'Count(project_1.Name)', 'display_alias': 'Count(Project 1.Name)'}], 'colspan': '1', 'id': 'cell1', 'colors': {'Count(institution_1.Name)': '#16DEC0', 'country_1.Name': '#F7FBFA', 'Count(project_1.Name)': '#D73E68'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': [['country_1.Name', 'Count(institution_1.Name)', 'Count(project_1.Name)'], ['Austria', 5, 5], ['Canada', 13, 13], ['Taiwan', 4, 4], ['Australia', 1, 1], ['Switzerland', 3, 3], ['Hungry', 1, 1], ['Belgium', 3, 3], ['Norway', 3, 3], ['Germany', 27, 27], ['Ireland', 1, 1], ['Italy', 6, 6], ['France', 3, 3], ['Poland', 1, 1], ['Denmark', 1, 1], ['China', 3, 3], ['Russia', 1, 1], ['Sweden', 2, 2], ['Netherlands', 8, 8], ['United States', 44, 44], ['Turkey', 1, 1], ['Latvia', 1, 1], ['Spain', 4, 4], ['New Zealand', 1, 1], ['Serbia', 1, 1], ['Israel', 1, 1], ['United Kingdom', 25, 25], ['Japan', 3, 3], ['Finland', 3, 3]], 'chartType': 'column', 'displayQuery': 3, 'col': 0, 'row': 0}, {'ySeries': [], 'rowspan': '1', 'displayMarkdown': '#Heading 1\n##Heading 2\n###Heading 3\n* A list of items\n - sub item', 'yAxis': [], 'colspan': '1', 'id': 'cell2', 'xAxis': '', 'series': [['Keanu Reeves', 36], ['Linus Torvalds', 24], ['Tyrion Lannister', 20], ['Morpheus', 1], ['F\xe9lix Lope de Vega Carpio', 156], ['Javier de la Rosa', 24]], 'chartType': '', 'displayQuery': '', 'col': 1, 'row': 0}], [{'ySeries': [], 'rowspan': '1', 'name': 'new count_inst', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}], 'colspan': 2, 'id': 'cell3', 'colors': {'Count(institution_1.Name)': '#1C93BA', 'country_1.Name': '#BA21E0'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': [['country_1.Name', 'Count(institution_1.Name)'], ['Austria', 3], ['Canada', 7], ['Taiwan', 3], ['Australia', 2], ['Switzerland', 3], ['Hungry', 1], ['Belgium', 2], ['Norway', 2], ['Germany', 28], ['Ireland', 1], ['Italy', 6], ['France', 3], ['Poland', 1], ['Denmark', 1], ['China', 3], ['Russia', 1], ['Sweden', 2], ['Netherlands', 6], ['United States', 35], ['Turkey', 1], ['Latvia', 1], ['Spain', 3], ['New Zealand', 1], ['Serbia', 1], ['Israel', 1], ['United Kingdom', 13], ['Japan', 3], ['Finland', 3]], 'chartType': 'line', 'displayQuery': 2, 'col': 0, 'row': 1}]], 'date_run': '"2015-04-16T17:30:00.577150"', 'id': 2}, {'table': [[{'ySeries': [], 'rowspan': '1', 'name': 'two_series', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}, {'alias': 'Count(project_1.Name)', 'display_alias': 'Count(Project 1.Name)'}], 'colspan': '1', 'col': 0, 'colors': {'Count(institution_1.Name)': '#16DEC0', 'country_1.Name': '#F7FBFA', 'Count(project_1.Name)': '#D73E68'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': [['country_1.Name', 'Count(institution_1.Name)', 'Count(project_1.Name)'], ['Austria', 5, 5], ['Canada', 13, 13], ['Taiwan', 4, 4], ['Australia', 1, 1], ['Switzerland', 3, 3], ['Hungry', 1, 1], ['Belgium', 3, 3], ['Norway', 3, 3], ['Germany', 27, 27], ['Ireland', 1, 1], ['Italy', 6, 6], ['France', 3, 3], ['Poland', 1, 1], ['Denmark', 1, 1], ['China', 3, 3], ['Russia', 1, 1], ['Sweden', 2, 2], ['Netherlands', 8, 8], ['United States', 44, 44], ['Turkey', 1, 1], ['Latvia', 1, 1], ['Spain', 4, 4], ['New Zealand', 1, 1], ['Serbia', 1, 1], ['Israel', 1, 1], ['United Kingdom', 25, 25], ['Japan', 3, 3], ['Finland', 3, 3]], 'chartType': 'column', 'displayQuery': 3, 'id': 'cell1', 'row': 0}, {'ySeries': [], 'rowspan': '1', 'displayMarkdown': '#Heading 1\n##Heading 2\n###Heading 3\n* A list of items\n - sub item', 'yAxis': [], 'colspan': '1', 'col': 1, 'xAxis': '', 'series': [['Keanu Reeves', 36], ['Linus Torvalds', 24], ['Tyrion Lannister', 20], ['Morpheus', 1], ['F\xe9lix Lope de Vega Carpio', 156], ['Javier de la Rosa', 24]], 'chartType': '', 'displayQuery': '', 'id': 'cell2', 'row': 0}], [{'ySeries': [], 'rowspan': '1', 'name': 'new count_inst', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}], 'colspan': 2, 'col': 0, 'colors': {'Count(institution_1.Name)': '#1C93BA', 'country_1.Name': '#BA21E0'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': [['country_1.Name', 'Count(institution_1.Name)'], ['Austria', 3], ['Canada', 7], ['Taiwan', 3], ['Australia', 2], ['Switzerland', 3], ['Hungry', 1], ['Belgium', 2], ['Norway', 2], ['Germany', 28], ['Ireland', 1], ['Italy', 6], ['France', 3], ['Poland', 1], ['Denmark', 1], ['China', 3], ['Russia', 1], ['Sweden', 2], ['Netherlands', 6], ['United States', 35], ['Turkey', 1], ['Latvia', 1], ['Spain', 3], ['New Zealand', 1], ['Serbia', 1], ['Israel', 1], ['United Kingdom', 13], ['Japan', 3], ['Finland', 3]], 'chartType': 'line', 'displayQuery': 2, 'id': 'cell3', 'row': 1}]], 'date_run': '"2015-04-16T17:00:00.981961"', 'id': 1}]}], 'previous_page_number': null}
        )

        historyInstEndpoint = $httpBackend.when('GET', '/reports/dh/history?report=2').respond(
            {'table': [[{'ySeries': [], 'rowspan': '1', 'name': 'two_series', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}, {'alias': 'Count(project_1.Name)', 'display_alias': 'Count(Project 1.Name)'}], 'colspan': '1', 'id': 'cell1', 'colors': {'Count(institution_1.Name)': '#16DEC0', 'country_1.Name': '#F7FBFA', 'Count(project_1.Name)': '#D73E68'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': [['country_1.Name', 'Count(institution_1.Name)', 'Count(project_1.Name)'], ['Austria', 5, 5], ['Canada', 13, 13], ['Taiwan', 4, 4], ['Australia', 1, 1], ['Switzerland', 3, 3], ['Hungry', 1, 1], ['Belgium', 3, 3], ['Norway', 3, 3], ['Germany', 27, 27], ['Ireland', 1, 1], ['Italy', 6, 6], ['France', 3, 3], ['Poland', 1, 1], ['Denmark', 1, 1], ['China', 3, 3], ['Russia', 1, 1], ['Sweden', 2, 2], ['Netherlands', 8, 8], ['United States', 44, 44], ['Turkey', 1, 1], ['Latvia', 1, 1], ['Spain', 4, 4], ['New Zealand', 1, 1], ['Serbia', 1, 1], ['Israel', 1, 1], ['United Kingdom', 25, 25], ['Japan', 3, 3], ['Finland', 3, 3]], 'chartType': 'column', 'displayQuery': 3, 'col': 0, 'row': 0}, {'ySeries': [], 'rowspan': '1', 'displayMarkdown': '#Heading 1\n##Heading 2\n###Heading 3\n* A list of items\n - sub item', 'yAxis': [], 'colspan': '1', 'id': 'cell2', 'xAxis': '', 'series': [['Keanu Reeves', 36], ['Linus Torvalds', 24], ['Tyrion Lannister', 20], ['Morpheus', 1], ['F\xe9lix Lope de Vega Carpio', 156], ['Javier de la Rosa', 24]], 'chartType': '', 'displayQuery': '', 'col': 1, 'row': 0}], [{'ySeries': [], 'rowspan': '1', 'name': 'new count_inst', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}], 'colspan': 2, 'id': 'cell3', 'colors': {'Count(institution_1.Name)': '#1C93BA', 'country_1.Name': '#BA21E0'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': [['country_1.Name', 'Count(institution_1.Name)'], ['Austria', 3], ['Canada', 7], ['Taiwan', 3], ['Australia', 2], ['Switzerland', 3], ['Hungry', 1], ['Belgium', 2], ['Norway', 2], ['Germany', 28], ['Ireland', 1], ['Italy', 6], ['France', 3], ['Poland', 1], ['Denmark', 1], ['China', 3], ['Russia', 1], ['Sweden', 2], ['Netherlands', 6], ['United States', 35], ['Turkey', 1], ['Latvia', 1], ['Spain', 3], ['New Zealand', 1], ['Serbia', 1], ['Israel', 1], ['United Kingdom', 13], ['Japan', 3], ['Finland', 3]], 'chartType': 'line', 'displayQuery': 2, 'col': 0, 'row': 1}]], 'date_run': '"2015-04-16T17:30:00.577150"', 'id': 2}
        )

        // The $controller service is used to create instances of controllers
        var $controller = $injector.get('$controller');

        createController = function($scope, ctrl) {
            return $controller(ctrl, {'$scope' : $scope });
        };
    }));

    afterEach(function() {
        $httpBackend.verifyNoOutstandingExpectation();
        $httpBackend.verifyNoOutstandingRequest();
    });


    it('Should fetch a single template', function() {
      $httpBackend.expectGET('/reports/dh/list?page=1');
      var $scope = {};
      var controller = createController($scope, 'ReportListCtrl');
      $httpBackend.flush();
      expect($scope.data.templates.length).toBe(1)
    });

    it('Should fetch a blank template', function () {
        $httpBackend.expectGET('/reports/dh/templates?queries=true');
        var $scope = {};
        var controller = createController($scope, 'NewReportCtrl');
        $httpBackend.flush();
        expect($scope.resp.queries.length).toBe(4)
    });

    it('Should fetch a preview', function () {
        $httpBackend.expectGET('/reports/dh/templates');
        var $scope = {};
        var controller = createController($scope, 'ReportPreviewCtrl');
        $httpBackend.flush();
        expect($scope.resp.queries.length).toBe(2)
    });

    it('Should fetch report history', function () {
        $httpBackend.expectGET('/reports/dh/history?page=1');
        $httpBackend.expectGET('/reports/dh/history?report=2');
        var $scope = {};
        var controller = createController($scope, 'ReportHistoryCtrl');
        $httpBackend.flush();
        expect($scope.template.reports.length).toBe(1)
    });
});


// This reptition simplifies testing, maybe remove later.
describe('ReportEditCtrl', function () {

    var $httpBackend, templateEndpointEdit, createController;

    beforeEach(module('reports'));

    beforeEach(inject(function($injector) {
        $httpBackend = $injector.get('$httpBackend');

        templateEndpointEdit = $httpBackend.when('GET', '/reports/dh/templates?queries=true').respond(
            {'template': {'frequency': 'h', 'layout': {'layout': [[{'ySeries': [], 'rowspan': '1', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}, {'alias': 'Count(project_1.Name)', 'display_alias': 'Count(Project 1.Name)'}], 'colspan': '1', 'col': 0, 'colors': {'Count(institution_1.Name)': '#16DEC0', 'country_1.Name': '#F7FBFA', 'Count(project_1.Name)': '#D73E68'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': '', 'chartType': 'column', 'displayQuery': 3, 'id': 'cell1', 'row': 0}, {'ySeries': [], 'rowspan': '1', 'displayMarkdown': '#Heading 1\n##Heading 2\n###Heading 3\n* A list of items\n - sub item', 'yAxis': [], 'colspan': '1', 'col': 1, 'xAxis': '', 'series': [['Keanu Reeves', 36], ['Linus Torvalds', 24], ['Tyrion Lannister', 20], ['Morpheus', 1], ['F\xe9lix Lope de Vega Carpio', 156], ['Javier de la Rosa', 24]], 'chartType': '', 'displayQuery': '', 'id': 'cell2', 'row': 0}], [{'ySeries': [], 'rowspan': '1', 'displayMarkdown': '', 'yAxis': [{'alias': 'Count(institution_1.Name)', 'display_alias': 'Count(Institution 1.Name)'}], 'colspan': 2, 'col': 0, 'colors': {'Count(institution_1.Name)': '#1C93BA', 'country_1.Name': '#BA21E0'}, 'xAxis': {'alias': 'country_1.Name', 'display_alias': 'Country 1.Name'}, 'series': '', 'chartType': 'line', 'displayQuery': 2, 'id': 'cell3', 'row': 1}]], 'pagebreaks': {'1': false, '0': false}}, 'name': 'Controller Test', 'collabs': [{'id': 'davebshow', 'display': 'davebshow'}], 'description': '', 'slug': 'controller-test', 'last_run': '"2015-04-16T17:30:00.577416"', 'start_date': '"2015-04-16T15:30:00"'}, 'queries': [{'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': []}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'datatype': 'string', 'alias': 'Count(institution_1.Name)', 'aggregate': 'Count', 'property': 'Name', 'distinct': false}]}, {'alias': 'located_in_1', 'properties': []}], 'name': 'count_inst', 'id': 1}, {'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'located_in_1', 'properties': []}], 'name': 'new count_inst', 'id': 2}, {'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'project_1', 'properties': [{'display_alias': 'Count(Project 1.Name)', 'alias': 'Count(project_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'produced_by_1', 'properties': []}, {'alias': 'located_in_1', 'properties': []}], 'name': 'two_series', 'id': 3}, {'series': [['color', 'count1', 'count2', 'count3', 'count4', 'count5'], ['yellow', 6, 7, 8, 9, 10], ['blue', 6.5, 5.5, 8, 7, 11], ['purple', 4.5, 5.5, 6, 9, 9.5], ['red', 5, 5.5, 4.5, 3, 6], ['green', 5, 6, 7.5, 9, 10]], 'results': [{'alias': 'country_1', 'properties': [{'display_alias': 'Country 1.Name', 'alias': 'country_1.Name', 'datatype': 'default', 'distinct': '', 'aggregate': false, 'property': 'Name'}]}, {'alias': 'institution_1', 'properties': [{'display_alias': 'Count(Institution 1.Name)', 'alias': 'Count(institution_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'project_1', 'properties': [{'display_alias': 'Count(Project 1.Name)', 'alias': 'Count(project_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'programming_1', 'properties': [{'display_alias': 'Count(Programming 1.Name)', 'alias': 'Count(programming_1.Name)', 'datatype': 'string', 'distinct': false, 'aggregate': 'Count', 'property': 'Name'}]}, {'alias': 'located_in_1', 'properties': []}, {'alias': 'produced_by_1', 'properties': []}, {'alias': 'necessary_for_6_1', 'properties': []}], 'name': 'three', 'id': 4}]}

        )

        var $controller = $injector.get('$controller');

        createController = function($scope, ctrl) {
                return $controller(ctrl, {'$scope' : $scope });
        };
    }));

    afterEach(function() {
        $httpBackend.verifyNoOutstandingExpectation();
        $httpBackend.verifyNoOutstandingRequest();
    });

    it('Should fetch an existing template', function () {
        $httpBackend.expectGET('/reports/dh/templates?queries=true');
        var $scope = {};
        var controller = createController($scope, 'EditReportCtrl');
        $httpBackend.flush();

    });
})
